<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ETrobocon2017: str/googletest/googlemock/docs/v1_5/ForDummies.md ソースファイル</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ETrobocon2017
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 構築: Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','検索');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d7/d91/v1__5_2_for_dummies_8md.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">str/googletest/googlemock/docs/v1_5/ForDummies.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d7/d91/v1__5_2_for_dummies_8md.html">[詳解]</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;(**Note:** If you get compiler errors that you don&#39;t understand, be sure to consult [Google Mock Doctor](V1_5_FrequentlyAskedQuestions#How_am_I_supposed_to_make_sense_of_these_horrible_template_error.md).)</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;# What Is Google C++ Mocking Framework? #</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;When you write a prototype or test, often it&#39;s not feasible or wise to rely on real objects entirely. A **mock object** implements the same interface as a real object (so it can be used as one), but lets you specify at run time how it will be used and what it should do (which methods will be called? in which order? how many times? with what arguments? what will they return? etc).</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;**Note:** It is easy to confuse the term _fake objects_ with mock objects. Fakes and mocks actually mean very different things in the Test-Driven Development (TDD) community:</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;  * **Fake** objects have working implementations, but usually take some shortcut (perhaps to make the operations less expensive), which makes them not suitable for production. An in-memory file system would be an example of a fake.</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;  * **Mocks** are objects pre-programmed with _expectations_, which form a specification of the calls they are expected to receive.</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;If all this seems too abstract for you, don&#39;t worry - the most important thing to remember is that a mock allows you to check the _interaction_ between itself and code that uses it. The difference between fakes and mocks will become much clearer once you start to use mocks.</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;**Google C++ Mocking Framework** (or **Google Mock** for short) is a library (sometimes we also call it a &quot;framework&quot; to make it sound cool) for creating mock classes and using them. It does to C++ what [jMock](http://www.jmock.org/) and [EasyMock](http://www.easymock.org/) do to Java.</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;Using Google Mock involves three basic steps:</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;  1. Use some simple macros to describe the interface you want to mock, and they will expand to the implementation of your mock class;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;  1. Create some mock objects and specify its expectations and behavior using an intuitive syntax;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;  1. Exercise code that uses the mock objects. Google Mock will catch any violation of the expectations as soon as it arises.</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;# Why Google Mock? #</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;While mock objects help you remove unnecessary dependencies in tests and make them fast and reliable, using mocks manually in C++ is _hard_:</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;  * Someone has to implement the mocks. The job is usually tedious and error-prone. No wonder people go great distance to avoid it.</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;  * The quality of those manually written mocks is a bit, uh, unpredictable. You may see some really polished ones, but you may also see some that were hacked up in a hurry and have all sorts of ad hoc restrictions.</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;  * The knowledge you gained from using one mock doesn&#39;t transfer to the next.</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;In contrast, Java and Python programmers have some fine mock frameworks, which automate the creation of mocks. As a result, mocking is a proven effective technique and widely adopted practice in those communities. Having the right tool absolutely makes the difference.</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;Google Mock was built to help C++ programmers. It was inspired by [jMock](http://www.jmock.org/) and [EasyMock](http://www.easymock.org/), but designed with C++&#39;s specifics in mind. It is your friend if any of the following problems is bothering you:</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;  * You are stuck with a sub-optimal design and wish you had done more prototyping before it was too late, but prototyping in C++ is by no means &quot;rapid&quot;.</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;  * Your tests are slow as they depend on too many libraries or use expensive resources (e.g. a database).</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  * Your tests are brittle as some resources they use are unreliable (e.g. the network).</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  * You want to test how your code handles a failure (e.g. a file checksum error), but it&#39;s not easy to cause one.</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  * You need to make sure that your module interacts with other modules in the right way, but it&#39;s hard to observe the interaction; therefore you resort to observing the side effects at the end of the action, which is awkward at best.</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  * You want to &quot;mock out&quot; your dependencies, except that they don&#39;t have mock implementations yet; and, frankly, you aren&#39;t thrilled by some of those hand-written mocks.</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;We encourage you to use Google Mock as:</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  * a _design_ tool, for it lets you experiment with your interface design early and often. More iterations lead to better designs!</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  * a _testing_ tool to cut your tests&#39; outbound dependencies and probe the interaction between your module and its collaborators.</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;# Getting Started #</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;Using Google Mock is easy! Inside your C++ source file, just `#include` `&lt;gtest/gtest.h&gt;` and `&lt;gmock/gmock.h&gt;`, and you are ready to go.</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;# A Case for Mock Turtles #</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;Let&#39;s look at an example. Suppose you are developing a graphics program that relies on a LOGO-like API for drawing. How would you test that it does the right thing? Well, you can run it and compare the screen with a golden screen snapshot, but let&#39;s admit it: tests like this are expensive to run and fragile (What if you just upgraded to a shiny new graphics card that has better anti-aliasing? Suddenly you have to update all your golden images.). It would be too painful if all your tests are like this. Fortunately, you learned about Dependency Injection and know the right thing to do: instead of having your application talk to the drawing API directly, wrap the API in an interface (say, `Turtle`) and code to that interface:</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;```</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;class Turtle {</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  ...</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  virtual ~Turtle() {}</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  virtual void PenUp() = 0;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  virtual void PenDown() = 0;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  virtual void Forward(int distance) = 0;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  virtual void Turn(int degrees) = 0;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  virtual void GoTo(int x, int y) = 0;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  virtual int GetX() const = 0;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  virtual int GetY() const = 0;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;};</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;```</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;(Note that the destructor of `Turtle` **must** be virtual, as is the case for **all** classes you intend to inherit from - otherwise the destructor of the derived class will not be called when you delete an object through a base pointer, and you&#39;ll get corrupted program states like memory leaks.)</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;You can control whether the turtle&#39;s movement will leave a trace using `PenUp()` and `PenDown()`, and control its movement using `Forward()`, `Turn()`, and `GoTo()`. Finally, `GetX()` and `GetY()` tell you the current position of the turtle.</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;Your program will normally use a real implementation of this interface. In tests, you can use a mock implementation instead. This allows you to easily check what drawing primitives your program is calling, with what arguments, and in which order. Tests written this way are much more robust (they won&#39;t break because your new machine does anti-aliasing differently), easier to read and maintain (the intent of a test is expressed in the code, not in some binary images), and run _much, much faster_.</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;# Writing the Mock Class #</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;If you are lucky, the mocks you need to use have already been implemented by some nice people. If, however, you find yourself in the position to write a mock class, relax - Google Mock turns this task into a fun game! (Well, almost.)</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;## How to Define It ##</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;Using the `Turtle` interface as example, here are the simple steps you need to follow:</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  1. Derive a class `MockTurtle` from `Turtle`.</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  1. Take a virtual function of `Turtle`. Count how many arguments it has.</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  1. In the `public:` section of the child class, write `MOCK_METHODn();` (or `MOCK_CONST_METHODn();` if you are mocking a `const` method), where `n` is the number of the arguments; if you counted wrong, shame on you, and a compiler error will tell you so.</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  1. Now comes the fun part: you take the function signature, cut-and-paste the _function name_ as the _first_ argument to the macro, and leave what&#39;s left as the _second_ argument (in case you&#39;re curious, this is the _type of the function_).</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  1. Repeat until all virtual functions you want to mock are done.</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;After the process, you should have something like:</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;```</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;#include &lt;gmock/gmock.h&gt;  // Brings in Google Mock.</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;class MockTurtle : public Turtle {</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160; public:</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  ...</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  MOCK_METHOD0(PenUp, void());</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  MOCK_METHOD0(PenDown, void());</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  MOCK_METHOD1(Forward, void(int distance));</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  MOCK_METHOD1(Turn, void(int degrees));</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  MOCK_METHOD2(GoTo, void(int x, int y));</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  MOCK_CONST_METHOD0(GetX, int());</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  MOCK_CONST_METHOD0(GetY, int());</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;};</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;```</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;You don&#39;t need to define these mock methods somewhere else - the `MOCK_METHOD*` macros will generate the definitions for you. It&#39;s that simple! Once you get the hang of it, you can pump out mock classes faster than your source-control system can handle your check-ins.</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;**Tip:** If even this is too much work for you, you&#39;ll find the</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;`gmock_gen.py` tool in Google Mock&#39;s `scripts/generator/` directory (courtesy of the [cppclean](http://code.google.com/p/cppclean/) project) useful.  This command-line</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;tool requires that you have Python 2.4 installed.  You give it a C++ file and the name of an abstract class defined in it,</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;and it will print the definition of the mock class for you.  Due to the</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;complexity of the C++ language, this script may not always work, but</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;it can be quite handy when it does.  For more details, read the [user documentation](http://code.google.com/p/googlemock/source/browse/trunk/scripts/generator/README).</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;## Where to Put It ##</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;When you define a mock class, you need to decide where to put its definition. Some people put it in a `*_test.cc`. This is fine when the interface being mocked (say, `Foo`) is owned by the same person or team. Otherwise, when the owner of `Foo` changes it, your test could break. (You can&#39;t really expect `Foo`&#39;s maintainer to fix every test that uses `Foo`, can you?)</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;So, the rule of thumb is: if you need to mock `Foo` and it&#39;s owned by others, define the mock class in `Foo`&#39;s package (better, in a `testing` sub-package such that you can clearly separate production code and testing utilities), and put it in a `mock_foo.h`. Then everyone can reference `mock_foo.h` from their tests. If `Foo` ever changes, there is only one copy of `MockFoo` to change, and only tests that depend on the changed methods need to be fixed.</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;Another way to do it: you can introduce a thin layer `FooAdaptor` on top of `Foo` and code to this new interface. Since you own `FooAdaptor`, you can absorb changes in `Foo` much more easily. While this is more work initially, carefully choosing the adaptor interface can make your code easier to write and more readable (a net win in the long run), as you can choose `FooAdaptor` to fit your specific domain much better than `Foo` does.</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;# Using Mocks in Tests #</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;Once you have a mock class, using it is easy. The typical work flow is:</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  1. Import the Google Mock names from the `testing` namespace such that you can use them unqualified (You only have to do it once per file. Remember that namespaces are a good idea and good for your health.).</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  1. Create some mock objects.</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  1. Specify your expectations on them (How many times will a method be called? With what arguments? What should it do? etc.).</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  1. Exercise some code that uses the mocks; optionally, check the result using Google Test assertions. If a mock method is called more than expected or with wrong arguments, you&#39;ll get an error immediately.</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  1. When a mock is destructed, Google Mock will automatically check whether all expectations on it have been satisfied.</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;Here&#39;s an example:</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;```</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;#include &quot;path/to/mock-turtle.h&quot;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;#include &lt;gmock/gmock.h&gt;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;#include &lt;gtest/gtest.h&gt;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;using ::testing::AtLeast;                     // #1</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;TEST(PainterTest, CanDrawSomething) {</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  MockTurtle turtle;                          // #2</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  EXPECT_CALL(turtle, PenDown())              // #3</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      .Times(AtLeast(1));</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  Painter painter(&amp;turtle);                   // #4</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;}                                             // #5</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;int main(int argc, char** argv) {</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  // The following line must be executed to initialize Google Mock</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  // (and Google Test) before running the tests.</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;  ::testing::InitGoogleMock(&amp;argc, argv);</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  return RUN_ALL_TESTS();</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;}</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;```</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;As you might have guessed, this test checks that `PenDown()` is called at least once. If the `painter` object didn&#39;t call this method, your test will fail with a message like this:</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;```</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;path/to/my_test.cc:119: Failure</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;Actual function call count doesn&#39;t match this expectation:</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;Actually: never called;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;Expected: called at least once.</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;```</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;**Tip 1:** If you run the test from an Emacs buffer, you can hit `&lt;Enter&gt;` on the line number displayed in the error message to jump right to the failed expectation.</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;**Tip 2:** If your mock objects are never deleted, the final verification won&#39;t happen. Therefore it&#39;s a good idea to use a heap leak checker in your tests when you allocate mocks on the heap.</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;**Important note:** Google Mock requires expectations to be set **before** the mock functions are called, otherwise the behavior is **undefined**. In particular, you mustn&#39;t interleave `EXPECT_CALL()`s and calls to the mock functions.</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;This means `EXPECT_CALL()` should be read as expecting that a call will occur _in the future_, not that a call has occurred. Why does Google Mock work like that? Well, specifying the expectation beforehand allows Google Mock to report a violation as soon as it arises, when the context (stack trace, etc) is still available. This makes debugging much easier.</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;Admittedly, this test is contrived and doesn&#39;t do much. You can easily achieve the same effect without using Google Mock. However, as we shall reveal soon, Google Mock allows you to do _much more_ with the mocks.</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;## Using Google Mock with Any Testing Framework ##</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;If you want to use something other than Google Test (e.g. [CppUnit](http://apps.sourceforge.net/mediawiki/cppunit/index.php?title=Main_Page) or</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;[CxxTest](http://cxxtest.tigris.org/)) as your testing framework, just change the `main()` function in the previous section to:</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;```</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;int main(int argc, char** argv) {</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  // The following line causes Google Mock to throw an exception on failure,</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  // which will be interpreted by your testing framework as a test failure.</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  ::testing::GTEST_FLAG(throw_on_failure) = true;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;  ::testing::InitGoogleMock(&amp;argc, argv);</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;  ... whatever your testing framework requires ...</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;}</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;```</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;This approach has a catch: it makes Google Mock throw an exception</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;from a mock object&#39;s destructor sometimes.  With some compilers, this</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;sometimes causes the test program to crash.  You&#39;ll still be able to</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;notice that the test has failed, but it&#39;s not a graceful failure.</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;A better solution is to use Google Test&#39;s</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;[event listener API](http://code.google.com/p/googletest/wiki/GoogleTestAdvancedGuide#Extending_Google_Test_by_Handling_Test_Events)</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;to report a test failure to your testing framework properly.  You&#39;ll need to</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;implement the `OnTestPartResult()` method of the event listener interface, but it</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;should be straightforward.</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;If this turns out to be too much work, we suggest that you stick with</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;Google Test, which works with Google Mock seamlessly (in fact, it is</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;technically part of Google Mock.).  If there is a reason that you</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;cannot use Google Test, please let us know.</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;# Setting Expectations #</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;The key to using a mock object successfully is to set the _right expectations_ on it. If you set the expectations too strict, your test will fail as the result of unrelated changes. If you set them too loose, bugs can slip through. You want to do it just right such that your test can catch exactly the kind of bugs you intend it to catch. Google Mock provides the necessary means for you to do it &quot;just right.&quot;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;## General Syntax ##</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;In Google Mock we use the `EXPECT_CALL()` macro to set an expectation on a mock method. The general syntax is:</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;```</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;EXPECT_CALL(mock_object, method(matchers))</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    .Times(cardinality)</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    .WillOnce(action)</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    .WillRepeatedly(action);</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;```</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;The macro has two arguments: first the mock object, and then the method and its arguments. Note that the two are separated by a comma (`,`), not a period (`.`). (Why using a comma? The answer is that it was necessary for technical reasons.)</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;The macro can be followed by some optional _clauses_ that provide more information about the expectation. We&#39;ll discuss how each clause works in the coming sections.</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;This syntax is designed to make an expectation read like English. For example, you can probably guess that</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;```</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;using ::testing::Return;...</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;EXPECT_CALL(turtle, GetX())</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    .Times(5)</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    .WillOnce(Return(100))</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    .WillOnce(Return(150))</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    .WillRepeatedly(Return(200));</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;```</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;says that the `turtle` object&#39;s `GetX()` method will be called five times, it will return 100 the first time, 150 the second time, and then 200 every time. Some people like to call this style of syntax a Domain-Specific Language (DSL).</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;**Note:** Why do we use a macro to do this? It serves two purposes: first it makes expectations easily identifiable (either by `grep` or by a human reader), and second it allows Google Mock to include the source file location of a failed expectation in messages, making debugging easier.</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;## Matchers: What Arguments Do We Expect? ##</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;When a mock function takes arguments, we must specify what arguments we are expecting; for example:</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;```</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;// Expects the turtle to move forward by 100 units.</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;EXPECT_CALL(turtle, Forward(100));</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;```</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;Sometimes you may not want to be too specific (Remember that talk about tests being too rigid? Over specification leads to brittle tests and obscures the intent of tests. Therefore we encourage you to specify only what&#39;s necessary - no more, no less.). If you care to check that `Forward()` will be called but aren&#39;t interested in its actual argument, write `_` as the argument, which means &quot;anything goes&quot;:</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;```</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;using ::testing::_;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;...</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;// Expects the turtle to move forward.</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;EXPECT_CALL(turtle, Forward(_));</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;```</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;`_` is an instance of what we call **matchers**. A matcher is like a predicate and can test whether an argument is what we&#39;d expect. You can use a matcher inside `EXPECT_CALL()` wherever a function argument is expected.</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;A list of built-in matchers can be found in the [CheatSheet](V1_5_CheatSheet.md). For example, here&#39;s the `Ge` (greater than or equal) matcher:</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;```</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;using ::testing::Ge;...</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;EXPECT_CALL(turtle, Forward(Ge(100)));</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;```</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;This checks that the turtle will be told to go forward by at least 100 units.</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;## Cardinalities: How Many Times Will It Be Called? ##</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;The first clause we can specify following an `EXPECT_CALL()` is `Times()`. We call its argument a **cardinality** as it tells _how many times_ the call should occur. It allows us to repeat an expectation many times without actually writing it as many times. More importantly, a cardinality can be &quot;fuzzy&quot;, just like a matcher can be. This allows a user to express the intent of a test exactly.</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;An interesting special case is when we say `Times(0)`. You may have guessed - it means that the function shouldn&#39;t be called with the given arguments at all, and Google Mock will report a Google Test failure whenever the function is (wrongfully) called.</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;We&#39;ve seen `AtLeast(n)` as an example of fuzzy cardinalities earlier. For the list of built-in cardinalities you can use, see the [CheatSheet](V1_5_CheatSheet.md).</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;The `Times()` clause can be omitted. **If you omit `Times()`, Google Mock will infer the cardinality for you.** The rules are easy to remember:</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;  * If **neither** `WillOnce()` **nor** `WillRepeatedly()` is in the `EXPECT_CALL()`, the inferred cardinality is `Times(1)`.</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;  * If there are `n WillOnce()`&#39;s but **no** `WillRepeatedly()`, where `n` &gt;= 1, the cardinality is `Times(n)`.</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;  * If there are `n WillOnce()`&#39;s and **one** `WillRepeatedly()`, where `n` &gt;= 0, the cardinality is `Times(AtLeast(n))`.</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;**Quick quiz:** what do you think will happen if a function is expected to be called twice but actually called four times?</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;## Actions: What Should It Do? ##</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;Remember that a mock object doesn&#39;t really have a working implementation? We as users have to tell it what to do when a method is invoked. This is easy in Google Mock.</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;First, if the return type of a mock function is a built-in type or a pointer, the function has a **default action** (a `void` function will just return, a `bool` function will return `false`, and other functions will return 0). If you don&#39;t say anything, this behavior will be used.</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;Second, if a mock function doesn&#39;t have a default action, or the default action doesn&#39;t suit you, you can specify the action to be taken each time the expectation matches using a series of `WillOnce()` clauses followed by an optional `WillRepeatedly()`. For example,</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;```</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;using ::testing::Return;...</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;EXPECT_CALL(turtle, GetX())</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    .WillOnce(Return(100))</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    .WillOnce(Return(200))</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    .WillOnce(Return(300));</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;```</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;This says that `turtle.GetX()` will be called _exactly three times_ (Google Mock inferred this from how many `WillOnce()` clauses we&#39;ve written, since we didn&#39;t explicitly write `Times()`), and will return 100, 200, and 300 respectively.</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;```</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;using ::testing::Return;...</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;EXPECT_CALL(turtle, GetY())</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    .WillOnce(Return(100))</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    .WillOnce(Return(200))</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    .WillRepeatedly(Return(300));</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;```</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;says that `turtle.GetY()` will be called _at least twice_ (Google Mock knows this as we&#39;ve written two `WillOnce()` clauses and a `WillRepeatedly()` while having no explicit `Times()`), will return 100 the first time, 200 the second time, and 300 from the third time on.</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;Of course, if you explicitly write a `Times()`, Google Mock will not try to infer the cardinality itself. What if the number you specified is larger than there are `WillOnce()` clauses? Well, after all `WillOnce()`s are used up, Google Mock will do the _default_ action for the function every time (unless, of course, you have a `WillRepeatedly()`.).</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;What can we do inside `WillOnce()` besides `Return()`? You can return a reference using `ReturnRef(variable)`, or invoke a pre-defined function, among [others](V1_5_CheatSheet#Actions.md).</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;**Important note:** The `EXPECT_CALL()` statement evaluates the action clause only once, even though the action may be performed many times. Therefore you must be careful about side effects. The following may not do what you want:</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;```</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;int n = 100;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;EXPECT_CALL(turtle, GetX())</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;.Times(4)</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;.WillOnce(Return(n++));</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;```</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;Instead of returning 100, 101, 102, ..., consecutively, this mock function will always return 100 as `n++` is only evaluated once. Similarly, `Return(new Foo)` will create a new `Foo` object when the `EXPECT_CALL()` is executed, and will return the same pointer every time. If you want the side effect to happen every time, you need to define a custom action, which we&#39;ll teach in the [CookBook](V1_5_CookBook.md).</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;Time for another quiz! What do you think the following means?</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;```</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;using ::testing::Return;...</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;EXPECT_CALL(turtle, GetY())</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;.Times(4)</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;.WillOnce(Return(100));</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;```</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;Obviously `turtle.GetY()` is expected to be called four times. But if you think it will return 100 every time, think twice! Remember that one `WillOnce()` clause will be consumed each time the function is invoked and the default action will be taken afterwards. So the right answer is that `turtle.GetY()` will return 100 the first time, but **return 0 from the second time on**, as returning 0 is the default action for `int` functions.</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;## Using Multiple Expectations ##</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;So far we&#39;ve only shown examples where you have a single expectation. More realistically, you&#39;re going to specify expectations on multiple mock methods, which may be from multiple mock objects.</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;By default, when a mock method is invoked, Google Mock will search the expectations in the **reverse order** they are defined, and stop when an active expectation that matches the arguments is found (you can think of it as &quot;newer rules override older ones.&quot;). If the matching expectation cannot take any more calls, you will get an upper-bound-violated failure. Here&#39;s an example:</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;```</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;using ::testing::_;...</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;EXPECT_CALL(turtle, Forward(_));  // #1</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;EXPECT_CALL(turtle, Forward(10))  // #2</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    .Times(2);</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;```</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;If `Forward(10)` is called three times in a row, the third time it will be an error, as the last matching expectation (#2) has been saturated. If, however, the third `Forward(10)` call is replaced by `Forward(20)`, then it would be OK, as now #1 will be the matching expectation.</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;**Side note:** Why does Google Mock search for a match in the _reverse_ order of the expectations? The reason is that this allows a user to set up the default expectations in a mock object&#39;s constructor or the test fixture&#39;s set-up phase and then customize the mock by writing more specific expectations in the test body. So, if you have two expectations on the same method, you want to put the one with more specific matchers **after** the other, or the more specific rule would be shadowed by the more general one that comes after it.</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;## Ordered vs Unordered Calls ##</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;By default, an expectation can match a call even though an earlier expectation hasn&#39;t been satisfied. In other words, the calls don&#39;t have to occur in the order the expectations are specified.</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;Sometimes, you may want all the expected calls to occur in a strict order. To say this in Google Mock is easy:</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;```</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;using ::testing::InSequence;...</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;TEST(FooTest, DrawsLineSegment) {</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  ...</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  {</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    InSequence dummy;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    EXPECT_CALL(turtle, PenDown());</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    EXPECT_CALL(turtle, Forward(100));</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    EXPECT_CALL(turtle, PenUp());</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;  }</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  Foo();</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;}</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;```</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;By creating an object of type `InSequence`, all expectations in its scope are put into a _sequence_ and have to occur _sequentially_. Since we are just relying on the constructor and destructor of this object to do the actual work, its name is really irrelevant.</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;In this example, we test that `Foo()` calls the three expected functions in the order as written. If a call is made out-of-order, it will be an error.</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;(What if you care about the relative order of some of the calls, but not all of them? Can you specify an arbitrary partial order? The answer is ... yes! If you are impatient, the details can be found in the [CookBook](V1_5_CookBook.md).)</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;## All Expectations Are Sticky (Unless Said Otherwise) ##</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;Now let&#39;s do a quick quiz to see how well you can use this mock stuff already. How would you test that the turtle is asked to go to the origin _exactly twice_ (you want to ignore any other instructions it receives)?</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;After you&#39;ve come up with your answer, take a look at ours and compare notes (solve it yourself first - don&#39;t cheat!):</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;```</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;using ::testing::_;...</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;EXPECT_CALL(turtle, GoTo(_, _))  // #1</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    .Times(AnyNumber());</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;EXPECT_CALL(turtle, GoTo(0, 0))  // #2</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    .Times(2);</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;```</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;Suppose `turtle.GoTo(0, 0)` is called three times. In the third time, Google Mock will see that the arguments match expectation #2 (remember that we always pick the last matching expectation). Now, since we said that there should be only two such calls, Google Mock will report an error immediately. This is basically what we&#39;ve told you in the &quot;Using Multiple Expectations&quot; section above.</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;This example shows that **expectations in Google Mock are &quot;sticky&quot; by default**, in the sense that they remain active even after we have reached their invocation upper bounds. This is an important rule to remember, as it affects the meaning of the spec, and is **different** to how it&#39;s done in many other mocking frameworks (Why&#39;d we do that? Because we think our rule makes the common cases easier to express and understand.).</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;Simple? Let&#39;s see if you&#39;ve really understood it: what does the following code say?</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;```</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;using ::testing::Return;</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;...</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;for (int i = n; i &gt; 0; i--) {</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;  EXPECT_CALL(turtle, GetX())</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;      .WillOnce(Return(10*i));</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;}</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;```</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;If you think it says that `turtle.GetX()` will be called `n` times and will return 10, 20, 30, ..., consecutively, think twice! The problem is that, as we said, expectations are sticky. So, the second time `turtle.GetX()` is called, the last (latest) `EXPECT_CALL()` statement will match, and will immediately lead to an &quot;upper bound exceeded&quot; error - this piece of code is not very useful!</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;One correct way of saying that `turtle.GetX()` will return 10, 20, 30, ..., is to explicitly say that the expectations are _not_ sticky. In other words, they should _retire_ as soon as they are saturated:</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;```</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;using ::testing::Return;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;...</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;for (int i = n; i &gt; 0; i--) {</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;  EXPECT_CALL(turtle, GetX())</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    .WillOnce(Return(10*i))</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    .RetiresOnSaturation();</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;}</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;```</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;And, there&#39;s a better way to do it: in this case, we expect the calls to occur in a specific order, and we line up the actions to match the order. Since the order is important here, we should make it explicit using a sequence:</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;```</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;using ::testing::InSequence;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;using ::testing::Return;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;...</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;{</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  InSequence s;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  for (int i = 1; i &lt;= n; i++) {</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    EXPECT_CALL(turtle, GetX())</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        .WillOnce(Return(10*i))</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        .RetiresOnSaturation();</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  }</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;}</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;```</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;By the way, the other situation where an expectation may _not_ be sticky is when it&#39;s in a sequence - as soon as another expectation that comes after it in the sequence has been used, it automatically retires (and will never be used to match any call).</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;## Uninteresting Calls ##</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;A mock object may have many methods, and not all of them are that interesting. For example, in some tests we may not care about how many times `GetX()` and `GetY()` get called.</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;In Google Mock, if you are not interested in a method, just don&#39;t say anything about it. If a call to this method occurs, you&#39;ll see a warning in the test output, but it won&#39;t be a failure.</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;# What Now? #</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;Congratulations! You&#39;ve learned enough about Google Mock to start using it. Now, you might want to join the [googlemock](http://groups.google.com/group/googlemock) discussion group and actually write some tests using Google Mock - it will be fun. Hey, it may even be addictive - you&#39;ve been warned.</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;Then, if you feel like increasing your mock quotient, you should move on to the [CookBook](V1_5_CookBook.md). You can learn many advanced features of Google Mock there -- and advance your level of enjoyment and testing bliss.</div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d7/d91/v1__5_2_for_dummies_8md.html">ForDummies.md</a></li>
    <li class="footer">構築:
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
