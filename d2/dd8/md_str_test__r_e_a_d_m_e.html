<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ETrobocon2017: Google C++ Testing Frameworkの使い方</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ETrobocon2017
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 構築: Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','検索');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d2/dd8/md_str_test__r_e_a_d_m_e.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Google C++ Testing Frameworkの使い方 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>ここではCygwinにおけるGoogle C++ Testing Frameworkの使い方について説明します。 わかってしまえばそんなに難しくないですが、ちょっと手間取りますから気を付けてください。</p>
<h2>長い前置き</h2>
<p>その前に簡単にGoogle C++ Testing Framework、通称Google Testとは何ぞやという説明だけさらっとしておきます。 簡単に言えばJUnitのC++バージョンです。 最初はCppUnitっていうのがC++でのデファクトスタンダートだったらしいですが、余りにも機能がシンプルすぎて使いづらいという話がちらほら出ていたそうです。 そこで、Googleが「俺の考えた最強のC++単体テストツール」を作ったみたいです。 そしてこれがなかなか便利なものでして、次の2点が有用な点として挙げられます。</p>
<ul>
<li>使いやすくドキュメントも豊富 -&gt; 他の単体テストツールでは使いづらかったり、ドキュメントが乏しかったりするらしい</li>
<li>Mockが使える -&gt; ちょっと調べた感じでは、C++でモックオブジェクトを作るのは難しいらしく、ほとんどないが、Google Testではデフォルトでモックを作ってくれるツールもセット、お得だね！</li>
</ul>
<p>ってな感じなので、使ってみました。</p>
<p>ただ、インターネット情報では2年前くらいのバージョン1.xシリーズの説明しかなく、現在のバージョン2.x系列のコンパイルや使い方の日本語での説明がほぼほぼなかったため、頑張って使い方を調べました。</p>
<p>これであなたもGoogle Testプロになれます、かねぇ？</p>
<h2>Google Mockの説明がないんですが</h2>
<p>実は、少し命名が悪いのか、混乱のもとになるかもしれませんので、ここで言っておきます。 上記の前置きで言っているGoogle Testというのは、Googleが開発しているC++用の単体テストツールのフレームワークのことです。 で、その中に次の2つが入っています。</p>
<ul>
<li>Google Test : 単体テストを作ってくれるライブラリ</li>
<li>Google <a class="el" href="../../d8/d46/class_mock.html">Mock</a> : モックオブジェクトを作ってくれるライブラリ</li>
</ul>
<p>ということは、厳密にはGoogle Testというのはモックオブジェクトを作らない単体テストを行う時に使えるものであって、決してGoogle Test = Google C++ Testing Frameworkではありません。</p>
<p>ですが、 Google C++ Testing Framework = Google Test = JUnitのC++版 と考えている方が何人かいるようで、混乱のもとになってるような気がします。 そのうちの一人は自分だったんですけどね。 ちなみに、 Google Test = JUnitのC++版 の式は成り立つことに気を付けてください。 Google <a class="el" href="../../d8/d46/class_mock.html">Mock</a> = jMockのC++版 みたいなものです。</p>
<p>そして、単体テストツールといえば、その2つを組み合わせたもの、つまりGoogle C++ Testing Framework = Google Test + Google Mockだと自分は考えています。</p>
<h2>Google Testをコンパイルしよう</h2>
<p>自分は最近まで統合開発環境でのJavaやスクリプト言語のPerlしか使わない生活だったせいで、コンパイルをするという動作を完全に忘れてしまってました。 そのせいで悪戦苦闘したので、まずはコンパイルをどうするかを丁寧に説明しようと思います。 くどいかもしれませんが、ご了承ください。</p>
<h3>GitHubに上がっているGoogle Testを取ってくる。</h3>
<p>大事ですね、でもここから説明しておきます。 その前に、カレントディレクトリを移動しておきましょう。 これからgit cloneするわけですが、カレントディレクトリ直下に配置するので（もちろん、gitのコマンドでカレントディレクトリ以外に置くこともできますが）、どこに置いておきたいかを考えてください。 ちなみに、テスト用ツールをコンパイルする際に、このディレクトリを参照するので、あまり遠くに置かないほうがいいと思います。</p>
<div class="fragment"><div class="line">$ git clone https://github.com/google/googletest.git</div></div><!-- fragment --><p>これで、カレントディレクトリ直下に配置されます。 疑っているのなら、lsでもしてみましょう。</p>
<div class="fragment"><div class="line">$ ls</div><div class="line">googletest そのほかのファイルやディレクトリ</div></div><!-- fragment --><p>もしかしたらGoogleさんがgoogletestリポジトリから移動させちゃったりしているかもしれませんが、その時は探してください、きっと見つかりますよ。</p>
<p>さて、苦労して入手できたら、いよいよコンパイルです。 コンパイルしなければならないのは2つです。</p>
<ul>
<li><a class="el" href="../../d3/d3a/gtest__main_8cc.html">gtest_main.cc</a></li>
<li><a class="el" href="../../d1/d8c/gtest-all_8cc.html">gtest-all.cc</a></li>
</ul>
<p>2つとも同じ場所にありますから、まずはその場所まで移動しましょう。</p>
<div class="fragment"><div class="line">$ cd googletest/googletest/src</div><div class="line"></div><div class="line">$ ls</div><div class="line">gtest.cc       gtest-all.cc         gtest-filepath.cc     gtest-port.cc      gtest-test-part.cc</div><div class="line">gtest_main.cc  gtest-death-test.cc  gtest-internal-inl.h  gtest-printers.cc  gtest-typed-test.cc</div></div><!-- fragment --><p>どうですか？ ちゃんとgtest_main.ccとgtest-all.ccが見つかったでしょうか？</p>
<p>さて、それではコンパイルです。 Makefileとかcmakeとかは知りません、ごり押しです。 まずはgtest_main.ccからです。</p>
<div class="fragment"><div class="line">$ g++ -I. -I../include -c gtest_main.cc</div></div><!-- fragment --><p>やけにすんなり通ってくれましたね。 lsをすればgtest_main.oがカレントディレクトリに入っていると思います。</p>
<p>次はgtest-all.ccです。</p>
<div class="fragment"><div class="line">$ g++ -I. -I.. -I../include -c gtest-all.cc</div></div><!-- fragment --><p>オプションとして-I..が追加されていることに注意してください。 これで、gtest-all.oもできているはずです。</p>
<p><b>注意</b></p>
<p>g++でコンパイルに失敗する人が多数いるそうです！ 自分がどうしてうまくいったのか調べたところ、Straberry Perl（WindowsでPerlを使えるようにするツール群）をインストールした際に、一緒に入っていたg++プログラムを呼び出してコンパイルしていました。 ただし、これが正しいとはとても思えないので、もっといい方法が見つかったら教えてください。</p>
<p>32bit版Cygwinにおいて、コンパイルに失敗する原因は、stddef.hを見つけられないというエラーでした。 そこでfindコマンドで検索してみたところ、次のディレクトリが見つかりました。</p>
<div class="fragment"><div class="line">$ find / -name stddef.h</div><div class="line">/home/katlabPC/ev3rt-beta7-release/hrp2/hrp2/target/ev3_gcc/drivers/common/virtual-linux-kernel/include/linux/stddef.h</div><div class="line">/home/katlabPC/ev3rt-beta7-release/hrp2/target/ev3_gcc/drivers/common/virtual-linux-kernel/include/linux/stddef.h</div><div class="line">/lib/gcc/i686-pc-cygwin/6.3.0/include/stddef.h</div><div class="line">/usr/lib/gcc/i686-pc-cygwin/6.3.0/include/stddef.h</div></div><!-- fragment --><p>よって、次のコマンドで無事コンパイルが確認できました。</p>
<div class="fragment"><div class="line">$ g++ -I. -I../include -I/lib/gcc/i686-pc-cygwin/6.3.0/include -c gtest_main.cc</div><div class="line">$ g++ -I. -I.. -I../include -I/lib/gcc/i686-pc-cygwin/6.3.0/include -c gtest-all.cc</div></div><!-- fragment --><p>また、コンパイルの失敗は確認できませんでしたが、テストファイル./a.exe実行時に何も表示されないというバグが発生しているようです。 g++とgccのバージョンを同じものにすると動くという情報があります。 例えば、次のような時にはうまく動作してくれました。</p>
<div class="fragment"><div class="line">$ gcc --version</div><div class="line">6.3.0</div><div class="line"></div><div class="line">$ g++ --version</div><div class="line">6.3.0</div></div><!-- fragment --><h4>ティーブレイク</h4>
<p>さて、実はgtest-all.ccのコンパイルを最初はしていませんでした！ なぜかというと、自分はこの-I..を付けていないがために、エラーをボカボカ出しました。 それでの解決策として、ソースコードを直接いじるという愚行を犯してしまいました。 とはいえそんなに難しくはありません。</p>
<p>#include "src/hogehoge.cc"がエラーだよ</p>
<p>との説明を受けたので、じゃあsrc/を消せばいいじゃんと考えました、はい。 そんなことを4ファイルくらいに適応してコンパイルを通しました。 皆さんはやらないほうがいいと思います。</p>
<h3>できたgtest_main.oとgtest-all.oファイルをテストコードがあるディレクトリにコピー</h3>
<p>これはそんなに難しくないですよね。</p>
<div class="fragment"><div class="line">$ cp \*.o 置きたいディレクトリ</div></div><!-- fragment --><p>とすれば移動します。 ETロボコンでは、次のディレクトリに置きました。</p>
<p>~/ev3rt-beta7-release/hrp2/sdk/etrobocon2017/str/test</p>
<p>結局この辺りが無難です。 ちなみに、etrobocon2017ディレクトリ内は次の通りです。</p>
<div class="fragment"><div class="line">etrobocon2017</div><div class="line">|-- Makefile</div><div class="line">|-- str</div><div class="line">    |-- app.cpp</div><div class="line">    |-- app.cfg</div><div class="line">    |-- app.h</div><div class="line">    |-- Makefile.inc</div><div class="line">    |-- 細かいファイルは省略</div><div class="line">    |-- app</div><div class="line">    |   |-- SonarAlert.cpp</div><div class="line">    |   |-- SonarAlert.h</div><div class="line">    |   |-- 省略</div><div class="line">    |-- googletest</div><div class="line">    |   |-- googletest</div><div class="line">    |       |-- include</div><div class="line">    |       |-- src</div><div class="line">    |       |-- 省略</div><div class="line">    |-- test</div><div class="line">        |-- gtest_main.o</div><div class="line">        |-- gtest-all.o</div><div class="line">        |-- テストコード置き場</div></div><!-- fragment --><h3>テストコードを書いてコンパイルしよう</h3>
<p>テストコードの書き方は具体例のほうがわかりやすいと思うので、ここのファイルをどれか適当に選んでください。</p>
<p>最低限書かなければならないのは次の文です。</p>
<div class="fragment"><div class="line">/**</div><div class="line"> * AddTest.cpp</div><div class="line"> * ヘッダファイルは書かなくてもいいらしい</div><div class="line"> */</div><div class="line"></div><div class="line">// googletest/googletest/include内のディレクトリおよびファイルをインクルードする。</div><div class="line">#include &lt;gtest/gtest.h&gt;</div><div class="line"></div><div class="line">// なんかのテストコード</div><div class="line">int add( int x, int y )</div><div class="line">{</div><div class="line">    return x + y;</div><div class="line">}</div><div class="line"></div><div class="line">// テストケース名とテスト内容を記述する。</div><div class="line">// テストケース名はこのテストクラス名、テスト内容は具体的なテストメンバ関数名を入れるといいかも。</div><div class="line">TEST( AddTest, get3add1and2 )</div><div class="line">{</div><div class="line">    // みんな大好きassertEqual文</div><div class="line">    // assertThat文に相当するものはないっぽいけど、ASSERT_EQ文でエラーが発生した時には、引数をコンソール上に表示してくれる完全上位互換</div><div class="line">    ASSERT_EQ( add( 1, 2 ), 3 );</div><div class="line">}</div></div><!-- fragment --><p>これをまずはコンパイルできるようにしましょう。 最低限使えるようなテストはこの後で行います。</p>
<p>まずはテストコードのコンパイルです。</p>
<div class="fragment"><div class="line">$ pwd</div><div class="line">~/ev3rt-beta7-release/hrp2/sdk/etrobocon2017/str/test</div></div><!-- fragment --><div class="fragment"><div class="line">$ ls</div><div class="line">AddTest.cpp gtest_main.o gtest-all.o</div><div class="line"></div><div class="line">$ g++ AddTest.cpp gtest_main.o gtest-all.o -I../googletest/googletest/include</div></div><!-- fragment --><p>これでコンパイルが成功すると、a.exeがカレントディレクトリに出現します。 こいつを実行すれば、いい感じに色も付いたきれいなテスト結果が表示されます。</p>
<p>おめでとうございます！ これであなたもGoogle Testプロです。</p>
<h3>せめて普通のクラスを単体テストしましょう</h3>
<p>これで終われるはずはないわけです。 普通に考えれば、テストコードにテストしたい内容を埋め込むなんてことはあり得ません。 では、別のファイルに存在するメンバ関数を呼び出しましょう。</p>
<p>その時のテストファイルはこちらです。</p>
<div class="fragment"><div class="line">/**</div><div class="line"> * SonarAlertTest.cpp</div><div class="line"> */</div><div class="line">#include &lt;gtest/gtest.h&gt;</div><div class="line">#include &lt;app/SonarAlert.h&gt; // このヘッダファイルのcppファイルをテスト</div><div class="line"></div><div class="line"></div><div class="line">// アラートする距離をコンストラクタで30にセットすると30を返す</div><div class="line">TEST( detectBarrierTest, return30WhenSetAlertDistance30 )</div><div class="line">{</div><div class="line">    // コンストラクタの引数に30を入れると、30という数値を初期値とする定数に代入</div><div class="line">    SonarAlert sonarAlert( 30 );</div><div class="line">    // 最初に入れた定数を返してほしい</div><div class="line">    ASSERT_EQ( sonarAlert.getDistanceBorder(), 30 );</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line">/**</div><div class="line"> * SonarAlert.cpp</div><div class="line"> */</div><div class="line">#include &quot;SonarAlert.h&quot;</div><div class="line"></div><div class="line">SonarAlert::SonarAlert( int distanceBorder ):</div><div class="line">    SONAR_ALERT_DISTANCE( distanceBorder ) {}</div><div class="line">/*</div><div class="line"> * SonarAlert::SonarAlert( int distanceBorder )</div><div class="line"> * {</div><div class="line"> *     SONAR_ALERT_DISTANCE = distanceBorder;</div><div class="line"> * }</div><div class="line"> * これではエラー！定数に代入はできないよ</div><div class="line"> */</div><div class="line"></div><div class="line">int SonarAlert::getDistanceBorder()</div><div class="line">{</div><div class="line">    return SONAR_ALERT_DISTANCE;</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line">/**</div><div class="line"> * SonarAlert.h</div><div class="line"> */</div><div class="line">#ifndef __SONARALERT__</div><div class="line">#define __SONARALERT__</div><div class="line"></div><div class="line">class SonarAlert {</div><div class="line">public:</div><div class="line">    SonarAlert( int );</div><div class="line">    int getDistanceBorder();</div><div class="line"></div><div class="line">private:</div><div class="line">    const signed int SONAR_ALERT_DISTANCE;</div><div class="line">};</div><div class="line"></div><div class="line">#endif</div></div><!-- fragment --><p>一気にそれっぽいものができましたね、ではコンパイルです。</p>
<div class="fragment"><div class="line">$ g++ ../app/SonarAlert.h ../app/SonarAlert.cpp SonarAlertTest.cpp gtest_main.o gtest-all.o -I.. -I../googletest/googletest/include</div></div><!-- fragment --><p>成功しましたか？</p>
<p>成功した -&gt; おめでとうございます！</p>
<p>成功しなかった -&gt; いくつか落とし穴があります、気を付けてみてください。</p>
<ul>
<li>SonarAlert.cppとSonarAlert.hはstr/appに入ってますか？</li>
<li>コンパイル引数の順番は合ってますか？</li>
<li>-I引数を間違えてませんか？</li>
</ul>
<p>これで一通りのことはできると思います。 今度こそGoogle Testプロです！</p>
<h2>Google Mockをコンパイルしよう</h2>
<p>今度はGoogle Mockを使ったテストをしてみましょう。</p>
<p>前置きでも言ったように、Google Test = ( JUnit + jMock )のC++版 という間違った構造が定着しているようなので、真のGoogle TestプロはGoogle Mockも使えないといけないのかもしれません。 それだけでなく、テストコードでモックが使えるようになるとかなり便利であり、テストコードを書けるといえばモックも使えると言っても過言ではありません。</p>
<p>Google MockはC++特有の問題を根本的に解決してくれない部分もいくつか存在しますが、そんなことはあんまり気にせずに、できそうなところだけ頑張ってみましょう。</p>
<h3>でもGoogle Mockってなんですか？</h3>
<p>それでは、前置きあたりでちらっと言ったGoogle Mockについて、もう少し説明します。</p>
<p>Google Mockというのは、モックオブジェクトを作ってくれるライブラリであるということは先ほど言いました。 じゃあモックオブジェクトってなんだよということなんですが、これは簡単に言ってしまえば、オブジェクトを仮実装してくれるツールです。</p>
<p>例えば、クラスAがクラスBのメンバ関数 <code>setItem(int)</code> を使っているメンバ関数 <code>isSettedItem()</code> をテストしたいとします。</p>
<div class="fragment"><div class="line">/*</div><div class="line"> * A.cpp</div><div class="line"> */</div><div class="line">class A</div><div class="line">{</div><div class="line">public:</div><div class="line">    A() {}</div><div class="line">    ~A() {}</div><div class="line">    bool isSettedItem();</div><div class="line">};</div><div class="line"></div><div class="line">bool A::isSettedItem(B *b)</div><div class="line">{</div><div class="line">    b.setItem(1);</div><div class="line">    return true;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">/*</div><div class="line"> * B.h</div><div class="line"> */</div><div class="line">class B</div><div class="line">{</div><div class="line">public:</div><div class="line">    virtual void setItem(int) = 0;</div><div class="line">};</div></div><!-- fragment --><p>しかし、クラスBの <code>setItem(int)</code> メンバ関数はまだ実装されていません。 あるいは、実装されているかもしれませんが、データベース処理などによる重い処理だとしたら、あまり時間をかけたくない場合もあります。 そのようなときに、仮実装するメンバ関数を一から作る、あるいは使うのは面倒だし時間がかかります。 そこで、そのメンバ関数を使ったように見せかけるメンバ関数を作ってくれると助かるよねという考えから作られたのがモックオブジェクトというものです。</p>
<div class="fragment"><div class="line">/*</div><div class="line"> * MockB.cpp</div><div class="line"> */</div><div class="line">class MockB : public B</div><div class="line">{</div><div class="line">public:</div><div class="line">    MOCK_METHOD1(setItem, void(int item));</div><div class="line">};</div></div><!-- fragment --><p>このとき、必要事項は次の5つです。</p>
<ul>
<li>モックを実装したいクラスを継承する。</li>
<li>モックを実装したいクラスの仮想引数を調べる。</li>
<li>モッククラスのpublicセクションにMOCK_METHODn();（constメンバ関数の場合はMOCK_CONST_METHODn();を書く。このとき、nには引数の数が入る。</li>
<li>関数名をマクロの1番目の引数に、メンバ関数の型を2番目の引数に入れる。また、メンバ関数の型のカッコの中には、そのメンバ関数の引数を入れる。</li>
<li>これを、モック化したい仮想関数全てに対して繰り返す。</li>
</ul>
<p>非仮想関数もモック化可能みたいですが、うまくいかなかったので、今回は仮想関数のみの説明です。</p>
<h3>Google Mockを使ってみよう</h3>
<p>では早速、先ほど説明したGoogle Mockを使ったテストをやってみましょう。 先ほども言ったように、モックオブジェクトというのは、実際に使うことに必要性はないが、使わないとテストができなようなクラスをテストする際に、仮想的なオブジェクトを読み込ませようという考え方で作られました。</p>
<p>組込み関数や組込みクラスでは、これは結構役に立つのではないかと思います。 例えば、 <code><a class="el" href="../../d4/d11/class_sonar_sensor.html">SonarSensor</a></code> クラスの <code>getDistance()</code> メンバ関数を使っている <code><a class="el" href="../../d7/d26/class_sonar_alert.html">SonarAlert</a></code> クラスをテストしたい場合、 <code><a class="el" href="../../d4/d11/class_sonar_sensor.html#ab5d39703f4424f7cdd872d9d1d5fc186">SonarSensor.getDistance()</a></code> はローカル上で使うことはできません。 <code><a class="el" href="../../d4/d11/class_sonar_sensor.html">SonarSensor</a></code> をモックオブジェクト化して、 <code>getDistance()</code> の戻り値を一意に決めてしまえば、わざわざ組込みマシンに入れなくてもテストできます。 便利ではないでしょうか！？</p>
<p>その前に、Google Testと同様に、Google Mockを作ってくれる実行ファイルを作りましょう。</p>
<p><code>googletest/googlemock/str</code> に入ってください。 そこで、次のコマンドを入力します。</p>
<div class="fragment"><div class="line">$ g++ -I../include -I../../googletest/include -c gmock_main.cc</div><div class="line">$ g++ -I.. -I../include -I../../googletest/include -c gmock-all.cc</div></div><!-- fragment --><p>カレントディレクトリにgmock_main.oとgmock-all.oが生成されていたら成功です。 では、この2つをtestディレクトリに入れましょう。 入れ方はもうわかりますよね？</p>
<p>それでは、テストクラスを書きましょう。 必要なコードは、次の5つです。</p>
<ul>
<li>SonarAlert.h（テスト対象コードのヘッダファイル）</li>
<li>SonarAlert.cpp（テスト対象コードの実装が書かれたクラスファイル）</li>
<li>SonarSensor.h（組込みクラスの仮想クラス）</li>
<li>MockSonarSensor.h（SonarSensor.hのモッククラス）</li>
<li>SonarAlertTest.cpp（テストコード）</li>
</ul>
<p>SonarSensor.hは、テストコードが存在するディレクトリに、新しく自分で作って置いちゃってください。 なぜかといえば、EV3APIが提供する組込みSonarSensor.hを読み込もうとすると、PATHが膨大になってしまい、本来の目的であるモックオブジェクトを作るという趣旨から離れてしまうからです。 また、EV3APIが提供する組込みSonarSensor.hのgetDistance()メンバ関数は非仮想関数であり、モックを作ることが一段と手間なので、さっさと仮想関数が入ったヘッダファイルを作っちゃったほうが早いと考えたためです。</p>
<p>本格的なテストの一部を取り出しているため、テスト対象コード（SonarAlert.cpp）が長くなっていますが、気にしないでください。</p>
<div class="fragment"><div class="line">/*</div><div class="line"> * SonarAlert.h</div><div class="line"> */</div><div class="line">#include &lt;SonarSensor.h&gt;</div><div class="line"></div><div class="line">class SonarAlert {</div><div class="line">public:</div><div class="line">    SonarAlert( int, int );</div><div class="line">    SonarAlert( int, int, SonarSensor&amp; ); // テスト用コンストラクタ</div><div class="line">    ~SonarAlert();</div><div class="line">    int detectBarrier(); // テスト対象メンバ関数</div><div class="line"></div><div class="line">private:</div><div class="line">    const signed int SONAR_ALERT_DISTANCE;</div><div class="line">    SonarSensor* sonarSensor;</div><div class="line">    unsigned int timeCounter;</div><div class="line">    unsigned int secPerCycle;</div><div class="line">};</div></div><!-- fragment --><div class="fragment"><div class="line">/*</div><div class="line"> * SonarAlert.cpp</div><div class="line"> */</div><div class="line">#include &quot;SonarAlert.h&quot;</div><div class="line"></div><div class="line">SonarAlert::SonarAlert( int distanceBorder, int secPerCycle ):</div><div class="line">    SONAR_ALERT_DISTANCE( distanceBorder )</div><div class="line">{</div><div class="line">    timeCounter = 0;</div><div class="line">    // sonarSensor = new SonarSensor( PORT_3 ); // テスト中はコメントアウト</div><div class="line">    this-&gt;secPerCycle = secPerCycle;</div><div class="line">}</div><div class="line"></div><div class="line">// テスト用コンストラクタ</div><div class="line">SonarAlert::SonarAlert( int distanceBorder, int secPerCycle, SonarSensor&amp; sensor):</div><div class="line">    SONAR_ALERT_DISTANCE( distanceBorder )</div><div class="line">{</div><div class="line">    timeCounter = 0;</div><div class="line">    sonarSensor = &amp;sensor;</div><div class="line">    this-&gt;secPerCycle = secPerCycle;</div><div class="line">}</div><div class="line"></div><div class="line">SonarAlert::~SonarAlert()</div><div class="line">{</div><div class="line">    // delete sonarSensor; // テスト中はコメントアウト</div><div class="line">}</div><div class="line"></div><div class="line">// テスト対象コード</div><div class="line">int SonarAlert::detectBarrier()</div><div class="line">{</div><div class="line">    timeCounter++;</div><div class="line">    int alert = 0;</div><div class="line"></div><div class="line">    if( timeCounter == 40/secPerCycle ) // 4msループなら10回に1回検知</div><div class="line">    {</div><div class="line">        if( sonarSensor-&gt;getDistance() &lt;= SONAR_ALERT_DISTANCE</div><div class="line">                &amp;&amp; 0 &lt;= sonarSensor-&gt;getDistance() )</div><div class="line">        {</div><div class="line">            alert = 1;</div><div class="line">        }</div><div class="line">        else</div><div class="line">        {</div><div class="line">            alert = 0;</div><div class="line">        }</div><div class="line">        timeCounter = 0;</div><div class="line">    }</div><div class="line"></div><div class="line">    return alert;</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line">/*</div><div class="line"> * SonarSensor.h</div><div class="line"> */</div><div class="line"></div><div class="line">// このヘッダファイルはテスト用です</div><div class="line">class SonarSensor {</div><div class="line">public:</div><div class="line">    SonarSensor() {}</div><div class="line">    virtual int getDistance() = 0; // 仮想関数</div><div class="line">};</div></div><!-- fragment --><div class="fragment"><div class="line">/*</div><div class="line"> * MockSonarSensor.h</div><div class="line"> */</div><div class="line">#include &quot;gmock/gmock.h&quot;</div><div class="line">#include &quot;SonarSensor.h&quot;</div><div class="line"></div><div class="line">class MockSonarSensor : public SonarSensor {</div><div class="line">public:</div><div class="line">    MOCK_METHOD0(getDistance, int());</div><div class="line">};</div></div><!-- fragment --><div class="fragment"><div class="line">/*</div><div class="line"> * SonarAlertTest.cpp</div><div class="line"> */</div><div class="line">#include &lt;gtest/gtest.h&gt;</div><div class="line">#include &lt;gmock/gmock.h&gt;</div><div class="line">#include &lt;app/SonarAlert.h&gt;</div><div class="line">#include &quot;MockSonarSensor.h&quot;</div><div class="line">using ::testing::AtLeast;</div><div class="line">using ::testing::Return;</div><div class="line"></div><div class="line">// アラート距離30以内（20）に入っていて10回目の観測では障害物を特定する</div><div class="line">TEST( detectBarrierTest, detectBarrierCheckTenTimesOnlyWhenSetAlertDistance30 )</div><div class="line">{</div><div class="line">    // モックを作ります</div><div class="line">    MockSonarSensor sonarSensor;</div><div class="line">    // モック内のメンバ関数を定義します</div><div class="line">    EXPECT_CALL( sonarSensor, getDistance() )</div><div class="line">        .Times(2) // 何回呼ばれるか</div><div class="line">        .WillRepeatedly( Return(20) ); // 戻り値は何か</div><div class="line">    // 作ったモックを埋め込みます</div><div class="line">    SonarAlert sonarAlert( 30, 4, sonarSensor );</div><div class="line"></div><div class="line">    for( int i = 0; i &lt; 9; i++ )</div><div class="line">        sonarAlert.detectBarrier();</div><div class="line"></div><div class="line">    ASSERT_EQ( sonarAlert.detectBarrier(), 1 );</div><div class="line">}</div></div><!-- fragment --><p>そして、カレントディレクトリを移動した現在の状況が次のようになっているとします。</p>
<div class="fragment"><div class="line">$ ls</div><div class="line">SonarAlert.h SonarAlert.cpp SonarAlertTest.cpp SonarSensor.h MockSonarSensor.cpp gtest_main.o gtest-all.o gmock_main.o gmock-all.o</div></div><!-- fragment --><p>そしたら、次のようなコマンドを入力すればいいかと思います。</p>
<div class="fragment"><div class="line">$ g++ SonarAlert.cpp SonarAlertTest.cpp gtest-all.o gmock_main.o gmock-all.o -I../googletest/googlemock/include -I../googletest/googletest/include</div></div><!-- fragment --><p>これでa.exeがカレントディレクトリに生成されて、実行できたら成功です。</p>
<p>気を付けて欲しいのは、gtest-all.oをコンパイルしている点と、../googletest/googletest/includeをパスに通している点です。 逆に、gtest_main.oはコンパイルしていません。</p>
<p>ここまでくれば、一般的なETロボコンのテストコードはほとんど書けると思います。 ここでついにあなたはGoogle Testプロになれました。 誇りましょう。</p>
<p>詳しいGoogle TestとGoogle Mockの使い方は次のURLを見てください。</p>
<ul>
<li><a href="http://opencv.jp/googletestdocs/index.html">http://opencv.jp/googletestdocs/index.html</a></li>
<li><a href="http://opencv.jp/googlemockdocs/index.html">http://opencv.jp/googlemockdocs/index.html</a></li>
</ul>
<h2>~~makeファイルを作ろう~~</h2>
<h2>makeファイルっぽいスクリプトを作ろう</h2>
<p>makeファイル？よくわかんないや！</p>
<p>ということで、皆さんおなじみ、Perlスクリプトでコマンドを作ってみました。</p>
<p>使い方は次の通りです。</p>
<div class="fragment"><div class="line">$ perl test.pl オプション テスト用コード</div></div><!-- fragment --><p>オプションには次のどっちかの文字が入ります。</p>
<ul>
<li>test</li>
<li>mock</li>
</ul>
<p>また、テスト用コードというのはテスト対象コードをテストするためのテスト用コードです。 "Test.cpp"というファイルなら何でもいいです。</p>
<p>オプションは、テスト用コードがモックを使っていないならtestを、使っているならmockを選んでください。</p>
<p>また、このスクリプトでは自動的にテストも実行してくれます。</p>
<p><b>注意事項</b></p>
<ul>
<li>このスクリプトでは、ファイルの存在有無は確認していません。 gtest_main.o、gtest-all.o、gmock_main.o、gmock-all.oは予め作っておいてください。</li>
<li>最後に自動実行するテストは、単純に作ったa.exeを実行するだけですが、もし最初に何らかのエラーで作れなかったとしても、カレントディレクトリにa.exeが存在した場合はそれを実行します。 気になる人は実行前にa.exeを消すといいかもしれません。 </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">構築:
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
